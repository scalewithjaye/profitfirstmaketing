<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Marketing Audit</title>
  
  <!-- jsPDF for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Anton&family=Hanken+Grotesk:wght@400;500;600;700&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* Remove number input arrows */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type=number] {
      -moz-appearance: textfield;
    }

    body {
      font-family: 'Hanken Grotesk', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #EAF6F6;
      color: #1a1a1a;
      line-height: 1.6;
    }

    .app-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 60px 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 60px;
    }

    .logo {
      font-family: 'Anton', sans-serif;
      font-size: 1.5rem;
      font-weight: 400;
      color: #1a1a1a;
      margin-bottom: 40px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }

    .header h1 {
      font-family: 'Anton', sans-serif;
      font-size: 3.5rem;
      font-weight: 400;
      color: #1a1a1a;
      margin-bottom: 16px;
      letter-spacing: 0.02em;
      line-height: 1.1;
      text-transform: uppercase;
    }

    .header p {
      font-size: 1.25rem;
      color: #666;
      font-weight: 400;
    }

    .progress-bar {
      background: #ffffff;
      border-radius: 8px;
      padding: 4px;
      margin-bottom: 40px;
      height: 12px;
      border: 1px solid #e5e5e5;
    }

    .progress-inner {
      height: 100%;
      background: linear-gradient(90deg, #94EEEE, #6dd5d5);
      border-radius: 6px;
      transition: width 0.5s ease;
    }

    .card {
      background: #ffffff;
      border: 1px solid #e5e5e5;
      border-radius: 12px;
      padding: 48px;
      margin-bottom: 40px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .card h2 {
      font-family: 'Anton', sans-serif;
      font-size: 2rem;
      font-weight: 400;
      color: #1a1a1a;
      margin-bottom: 8px;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }

    .card .subtitle {
      color: #666;
      font-size: 1rem;
      margin-bottom: 32px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
      margin-bottom: 32px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 8px;
      font-size: 0.95rem;
    }

    .form-group .help-text {
      font-size: 0.85rem;
      color: #999;
      margin-top: 4px;
    }

    .form-group input {
      padding: 12px 16px;
      background: #ffffff;
      border: 1px solid #e5e5e5;
      border-radius: 6px;
      color: #1a1a1a;
      font-size: 1rem;
      font-family: 'Hanken Grotesk', sans-serif;
      transition: all 0.2s ease;
    }

    .form-group input:focus {
      outline: none;
      border-color: #94EEEE;
      box-shadow: 0 0 0 3px rgba(148, 238, 238, 0.1);
    }

    .channel-input-group {
      background: #EAF6F6;
      padding: 24px;
      border-radius: 8px;
      margin-bottom: 16px;
      border: 1px solid rgba(148, 238, 238, 0.3);
    }

    .channel-input-group h4 {
      color: #1a1a1a;
      margin-bottom: 16px;
      font-size: 1rem;
      font-weight: 600;
    }

    .button-group {
      display: flex;
      gap: 16px;
      justify-content: space-between;
      margin-top: 40px;
    }

    .btn {
      padding: 14px 32px;
      border-radius: 6px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      font-family: 'Hanken Grotesk', sans-serif;
    }

    .btn-primary {
      background: #1a1a1a;
      color: #ffffff;
    }

    .btn-primary:hover {
      background: #000000;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .btn-secondary {
      background: #ffffff;
      color: #1a1a1a;
      border: 1px solid #e5e5e5;
    }

    .btn-secondary:hover {
      background: #EAF6F6;
      border-color: #94EEEE;
    }

    .metric-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .metric-card {
      background: #EAF6F6;
      padding: 24px;
      border-radius: 8px;
      border: 1px solid rgba(148, 238, 238, 0.3);
    }

    .metric-card .label {
      color: #666;
      font-size: 0.85rem;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 600;
    }

    .metric-card .value {
      font-family: 'Anton', sans-serif;
      font-size: 2.5rem;
      font-weight: 400;
      color: #1a1a1a;
      letter-spacing: 0.02em;
    }

    .metric-card.positive .value {
      color: #059669;
    }

    .metric-card.negative .value {
      color: #dc2626;
    }

    .results-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 32px;
      font-size: 0.9rem;
      background: #ffffff;
      border-radius: 8px;
      overflow: hidden;
    }

    .results-table th {
      background: #EAF6F6;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid #94EEEE;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .results-table td {
      padding: 12px;
      border-bottom: 1px solid #f0f0f0;
    }

    .results-table tr:last-child td {
      border-bottom: none;
    }

    .health-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .health-excellent {
      background: #d1fae5;
      color: #065f46;
    }

    .health-good {
      background: #fef3c7;
      color: #92400e;
    }

    .health-acceptable {
      background: #fed7aa;
      color: #9a3412;
    }

    .health-poor {
      background: #fee2e2;
      color: #991b1b;
    }

    .chart-container {
      background: #ffffff;
      padding: 32px;
      border-radius: 8px;
      margin-bottom: 32px;
      border: 1px solid #e5e5e5;
    }

    .chart-container h3 {
      font-family: 'Anton', sans-serif;
      color: #1a1a1a;
      margin-bottom: 24px;
      font-size: 1.5rem;
      font-weight: 400;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }

    .chart-bars {
      display: flex;
      align-items: flex-end;
      justify-content: space-around;
      height: 300px;
      margin-top: 20px;
      padding: 20px 0;
      border-bottom: 2px solid #e5e5e5;
    }

    .chart-bar {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 100px;
      margin: 0 8px;
    }

    .bar-column {
      width: 100%;
      min-height: 20px;
      border-radius: 4px 4px 0 0;
      transition: all 0.3s ease;
      position: relative;
    }

    .bar-value {
      position: absolute;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.75rem;
      color: #1a1a1a;
      white-space: nowrap;
      font-weight: 600;
    }

    .bar-label {
      margin-top: 8px;
      font-size: 0.7rem;
      color: #666;
      text-align: center;
      word-wrap: break-word;
      line-height: 1.2;
    }

    .insights-section {
      background: #EAF6F6;
      border: 2px solid #94EEEE;
      border-radius: 8px;
      padding: 32px;
      margin-top: 40px;
    }

    .insights-section h3 {
      font-family: 'Anton', sans-serif;
      color: #1a1a1a;
      font-size: 1.5rem;
      font-weight: 400;
      margin-bottom: 20px;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }

    .insight-item {
      background: #ffffff;
      padding: 20px;
      border-radius: 6px;
      margin-bottom: 16px;
      border-left: 3px solid #94EEEE;
    }

    .insight-item strong {
      color: #1a1a1a;
    }

    .ai-badge {
      display: inline-block;
      background: #94EEEE;
      color: #1a1a1a;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
      margin-left: 8px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .loading-insights {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .loading-insights .spinner {
      border: 3px solid #f0f0f0;
      border-top: 3px solid #94EEEE;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .cta-box {
      margin-top: 48px;
      padding: 40px;
      background: #1a1a1a;
      border-radius: 8px;
      text-align: center;
      color: #ffffff;
    }

    .cta-box h3 {
      font-family: 'Anton', sans-serif;
      color: #ffffff;
      margin-bottom: 16px;
      font-size: 1.75rem;
      font-weight: 400;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }

    .cta-box p {
      margin-bottom: 24px;
      font-size: 1.1rem;
      color: #e5e5e5;
    }

    .cta-box .btn-primary {
      background: #94EEEE;
      color: #1a1a1a;
    }

    .cta-box .btn-primary:hover {
      background: #7de0e0;
    }

    /* AI Chat Box Styles */
    .ai-chat-box {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 380px;
      max-height: 60px; /* Start minimized */
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      border: 2px solid #94EEEE;
      display: flex;
      flex-direction: column;
      z-index: 1000;
      transition: all 0.3s ease;
      overflow: hidden;
    }

    .ai-chat-box.expanded {
      max-height: 500px;
    }

    .ai-chat-box.minimized {
      max-height: 60px;
    }

    .ai-chat-header {
      background: linear-gradient(135deg, #94EEEE, #6dd5d5);
      padding: 16px 20px;
      border-radius: 10px 10px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }

    .ai-chat-header h4 {
      font-family: 'Anton', sans-serif;
      font-size: 1rem;
      color: #1a1a1a;
      margin: 0;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .ai-chat-toggle {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #1a1a1a;
      line-height: 1;
    }

    .ai-chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      max-height: 400px;
      min-height: 200px;
    }

    .ai-message {
      margin-bottom: 16px;
      padding: 12px 16px;
      border-radius: 8px;
      line-height: 1.5;
      font-size: 0.9rem;
    }

    .ai-message.user {
      background: #EAF6F6;
      margin-left: 40px;
      border: 1px solid #94EEEE;
    }

    .ai-message.assistant {
      background: #f5f5f5;
      margin-right: 40px;
      border: 1px solid #e5e5e5;
    }

    .ai-message.assistant strong {
      color: #1a1a1a;
    }

    .ai-message.loading {
      background: #f5f5f5;
      margin-right: 40px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .ai-message.loading .dots {
      display: flex;
      gap: 4px;
    }

    .ai-message.loading .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #94EEEE;
      animation: bounce 1.4s infinite ease-in-out both;
    }

    .ai-message.loading .dot:nth-child(1) { animation-delay: -0.32s; }
    .ai-message.loading .dot:nth-child(2) { animation-delay: -0.16s; }

    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    .ai-chat-input-container {
      padding: 16px;
      border-top: 1px solid #e5e5e5;
      display: flex;
      gap: 8px;
    }

    .ai-chat-input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid #e5e5e5;
      border-radius: 6px;
      font-family: 'Hanken Grotesk', sans-serif;
      font-size: 0.9rem;
      resize: none;
      max-height: 100px;
    }

    .ai-chat-input:focus {
      outline: none;
      border-color: #94EEEE;
    }

    .ai-chat-send {
      padding: 10px 16px;
      background: #1a1a1a;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-family: 'Hanken Grotesk', sans-serif;
      font-size: 0.9rem;
    }

    .ai-chat-send:hover {
      background: #000000;
    }

    .ai-chat-send:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    @media (max-width: 768px) {
      .ai-chat-box {
        width: calc(100% - 40px);
        right: 20px;
        left: 20px;
        max-height: 500px;
      }
    }

    .hidden {
      display: none !important;
    }

    @media (max-width: 768px) {
      .header h1 {
        font-size: 2.5rem;
      }
      
      .card {
        padding: 32px 24px;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .button-group {
        flex-direction: column;
      }

      .chart-bars {
        height: 250px;
      }
    }

    @media print {
      .button-group, .cta-box, .btn {
        display: none !important;
      }
      
      body {
        background: white;
      }
      
      .card {
        page-break-inside: avoid;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="progress-bar">
      <div class="progress-inner" id="progressBar" style="width: 50%"></div>
    </div>

    <!-- Step 1: Business Fundamentals -->
    <div id="step1" class="card">
      <h2>Step 1: Business Fundamentals</h2>
      <p class="subtitle">Let's start with your core business metrics</p>
      
      <div class="form-grid">
        <div class="form-group">
          <label>Average Order Value (AOV)</label>
          <input type="number" id="aov" placeholder="125.00" step="0.01">
          <span class="help-text">Your average order value in dollars</span>
        </div>

        <div class="form-group">
          <label>Cost of Goods Sold (%)</label>
          <input type="number" id="cogsPercent" placeholder="40" step="0.1">
          <span class="help-text">Product costs as % of revenue</span>
        </div>

        <div class="form-group">
          <label>Customer Lifetime (months)</label>
          <input type="number" id="customerLifetime" placeholder="24" step="1">
          <span class="help-text">How long customers typically buy from you</span>
        </div>

        <div class="form-group">
          <label>Purchase Frequency (per year)</label>
          <input type="number" id="purchaseFrequency" placeholder="3" step="0.1">
          <span class="help-text">Average orders per customer annually</span>
        </div>

        <div class="form-group">
          <label>Sales Cycle Length (days)</label>
          <input type="number" id="salesCycle" placeholder="90" step="1">
          <span class="help-text">Time from first touch to purchase (in days)</span>
        </div>
      </div>

      <div class="button-group">
        <div></div>
        <button class="btn btn-primary" onclick="goToStep2()">
          Next: Channel Performance ‚Üí
        </button>
      </div>
    </div>

    <!-- Step 2: Channel Performance -->
    <div id="step2" class="card hidden">
      <h2>Step 2: Channel Performance</h2>
      <p class="subtitle">Enter data for the channels you're actively using</p>
      
      <div id="channelInputs"></div>

      <div class="button-group">
        <button class="btn btn-secondary" onclick="goToStep1()">
          ‚Üê Back
        </button>
        <button class="btn btn-primary" onclick="showEmailGate()">
          Calculate My Results ‚Üí
        </button>
      </div>
    </div>

    <!-- Email Gate -->
    <div id="emailGate" class="hidden">
      <div class="card">
        <div style="text-align: center; max-width: 500px; margin: 0 auto;">
          <h2 style="margin-bottom: 12px;">üéâ Your Audit is Ready!</h2>
          <p style="color: #666; margin-bottom: 32px; font-size: 1.1rem;">
            Enter your email to unlock your personalized AI-powered marketing strategy, including:
          </p>
          
          <div style="text-align: left; background: #EAF6F6; padding: 24px; border-radius: 8px; margin-bottom: 32px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <span style="font-size: 1.2rem;">üìä</span>
              <span>Channel-by-channel performance analysis</span>
            </div>
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <span style="font-size: 1.2rem;">ü§ñ</span>
              <span>AI-powered strategic recommendations</span>
            </div>
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <span style="font-size: 1.2rem;">üí∞</span>
              <span>Optimized budget allocation plan</span>
            </div>
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <span style="font-size: 1.2rem;">üöÄ</span>
              <span>Specific actions to scale winners</span>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
              <span style="font-size: 1.2rem;">üì•</span>
              <span>Downloadable PDF report</span>
            </div>
          </div>

          <form id="emailGateForm" onsubmit="handleEmailSubmit(event)">
            <div class="form-group" style="margin-bottom: 16px;">
              <input type="text" id="leadName" placeholder="Your Name" required style="width: 100%; padding: 14px; border: 1px solid #e5e5e5; border-radius: 6px; font-size: 1rem;">
            </div>
            <div class="form-group" style="margin-bottom: 16px;">
              <input type="email" id="leadEmail" placeholder="Your Email" required style="width: 100%; padding: 14px; border: 1px solid #e5e5e5; border-radius: 6px; font-size: 1rem;">
            </div>
            <div class="form-group" style="margin-bottom: 16px;">
              <input type="text" id="leadCompany" placeholder="Company Name (optional)" style="width: 100%; padding: 14px; border: 1px solid #e5e5e5; border-radius: 6px; font-size: 1rem;">
            </div>
            <div class="form-group" style="margin-bottom: 24px;">
              <select id="leadSpend" style="width: 100%; padding: 14px; border: 1px solid #e5e5e5; border-radius: 6px; font-size: 1rem; background: white;">
                <option value="">Monthly Marketing Spend (optional)</option>
                <option value="<5000">Less than $5,000</option>
                <option value="5000-15000">$5,000 - $15,000</option>
                <option value="15000-50000">$15,000 - $50,000</option>
                <option value="50000-100000">$50,000 - $100,000</option>
                <option value=">100000">More than $100,000</option>
              </select>
            </div>
            
            <button type="submit" class="btn btn-primary" id="unlockResultsBtn" style="width: 100%; padding: 16px; font-size: 1.1rem;">
              Unlock My Results ‚Üí
            </button>
            
            <p style="color: #999; font-size: 0.85rem; margin-top: 16px;">
              üîí No spam. Unsubscribe anytime.
            </p>
          </form>
        </div>
      </div>
    </div>

    <!-- Step 3: Results -->
    <div id="step3" class="hidden">
      <div class="card">
        <h2>Your Profit-First Audit Results</h2>
        <p class="subtitle">Here's what your data reveals about marketing profitability</p>

        <div class="metric-cards" id="metricCards"></div>

        <h3 style="margin-bottom: 20px; font-size: 1.25rem; font-weight: 600;">Channel Performance Summary</h3>
        <table class="results-table" id="resultsTable"></table>

        <div class="chart-container">
          <h3>Monthly Profit by Channel</h3>
          <div class="chart-bars" id="profitChart"></div>
        </div>

        <div class="chart-container">
          <h3>CAC:LTV Ratio by Channel</h3>
          <div class="chart-bars" id="cacLtvChart"></div>
          <p style="text-align: center; color: #666; margin-top: 16px; font-size: 0.85rem">
            Green = Excellent (&lt;0.33) | Yellow = Good (0.33-0.5) | Orange = Acceptable (0.5-1.0) | Red = Poor (&gt;1.0)
          </p>
        </div>

        <div class="insights-section">
          <h3>ü§ñ AI-Powered Marketing Strategy</h3>
          <div id="insightsList"></div>
        </div>

        <div class="button-group" style="margin-top: 40px">
          <button class="btn btn-secondary" onclick="goToStep2FromResults()">
            ‚Üê Edit Data
          </button>
          <button class="btn btn-primary" onclick="generatePDF()">
            üì• Download PDF Report
          </button>
        </div>

        <div class="cta-box">
          <h3>Want Expert Help Interpreting These Results?</h3>
          <p>
            Book a complimentary 30-minute audit review call where we'll identify your biggest profit leaks 
            and create an action plan to improve your marketing ROI.
          </p>
          <button class="btn btn-primary" style="font-size: 1.1rem" onclick="window.location.href='https://www.scalewithjaye.com/#schedule'">
            Schedule Free Audit Review ‚Üí
          </button>
        </div>
      </div>
    </div>

    <!-- AI Chat Box -->
    <div class="ai-chat-box" id="aiChatBox">
      <div class="ai-chat-header" onclick="toggleAIChat()">
        <h4 id="aiChatTitle">Metrics have you stumped? Ask Claude.</h4>
        <button class="ai-chat-toggle" id="aiChatToggle">+</button>
      </div>
      <div class="ai-chat-messages" id="aiChatMessages">
        <div class="ai-message assistant">
          <strong>Claude:</strong> Hi! I'm here to help you complete your marketing audit. Ask me anything about marketing metrics, channel performance, or strategy.
        </div>
      </div>
      <div class="ai-chat-input-container">
        <textarea 
          class="ai-chat-input" 
          id="aiChatInput" 
          placeholder="Ask a question..."
          rows="1"
        ></textarea>
        <button class="ai-chat-send" id="aiChatSend" onclick="sendAIMessage()">Send</button>
      </div>
    </div>
  </div>

  <script>
    // =====================================================
    // CONFIGURATION - Update this with your Vercel URL
    // =====================================================
    const API_URL = 'https://scalewithjayeapi-yplt.vercel.app/api/claude';
    // After deploying to Vercel, replace YOUR-PROJECT-NAME with your actual project name
    // Example: 'https://scalewithjaye-api.vercel.app/api/claude'
    // =====================================================

    // =====================================================
    // MAILCHIMP CONFIGURATION
    // =====================================================
    // Replace with your Mailchimp form action URL
    // Find this in Mailchimp: Audience ‚Üí Signup forms ‚Üí Embedded forms ‚Üí Copy the form action URL
    const MAILCHIMP_URL = 'https://scalewithjaye.us19.list-manage.com/subscribe/post?u=22f4be952e2b4f973867dfcb1&id=13190a159a&f_id=0032b3e4f0';
    // Example: 'https://scalewithjaye.us1.list-manage.com/subscribe/post?u=XXXXX&id=XXXXX'
    // =====================================================

    const defaultChannels = [
      'Meta Ads (Facebook/Instagram)',
      'Google Ads (Search)',
      'Google Ads (Shopping)',
      'TikTok Ads',
      'Email Marketing',
      'SMS Marketing'
    ];

    let channels = [...defaultChannels];
    let channelData = [];
    let businessData = {};
    let results = {};
    let aiInsightsData = [];

    // Define these functions FIRST before anything else
    function addCustomChannel() {
      console.log('addCustomChannel called');
      
      // Create a custom modal instead of using prompt()
      const modal = document.createElement('div');
      modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
      
      const modalContent = document.createElement('div');
      modalContent.style.cssText = 'background: white; padding: 30px; border-radius: 12px; max-width: 400px; width: 90%;';
      modalContent.innerHTML = `
        <h3 style="margin: 0 0 20px 0; color: #1a1a1a; font-family: Anton, sans-serif;">Add Custom Channel</h3>
        <input type="text" id="customChannelInput" placeholder="Enter channel name" style="width: 100%; padding: 12px; border: 1px solid #e5e5e5; border-radius: 6px; font-size: 1rem; margin-bottom: 20px;" />
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
          <button id="cancelChannelBtn" style="padding: 10px 20px; background: #f5f5f5; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Cancel</button>
          <button id="addChannelBtn" style="padding: 10px 20px; background: #1a1a1a; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Add Channel</button>
        </div>
      `;
      
      modal.appendChild(modalContent);
      document.body.appendChild(modal);
      
      const input = document.getElementById('customChannelInput');
      input.focus();
      
      // Handle add button
      document.getElementById('addChannelBtn').onclick = function() {
        const newChannelName = input.value.trim();
        if (!newChannelName) {
          alert('Please enter a channel name');
          return;
        }
        
        console.log('Adding channel:', newChannelName);
        channels.push(newChannelName);
        
        // Re-render inputs while preserving existing values
        const existingData = channels.slice(0, -1).map((ch, index) => ({
          name: document.getElementById(`channel-name-${index}`)?.textContent.trim() || ch,
          spend: document.getElementById(`spend_${index}`)?.value || '',
          customers: document.getElementById(`customers_${index}`)?.value || '',
          revenue: document.getElementById(`revenue_${index}`)?.value || ''
        }));
        
        initChannelInputs();
        
        // Restore values
        existingData.forEach((data, index) => {
          const nameEl = document.getElementById(`channel-name-${index}`);
          if (nameEl) nameEl.textContent = data.name;
          const spendEl = document.getElementById(`spend_${index}`);
          if (spendEl) spendEl.value = data.spend;
          const custEl = document.getElementById(`customers_${index}`);
          if (custEl) custEl.value = data.customers;
          const revEl = document.getElementById(`revenue_${index}`);
          if (revEl) revEl.value = data.revenue;
        });
        
        // Remove modal
        document.body.removeChild(modal);
        
        // Scroll to the new channel
        setTimeout(() => {
          const newChannelGroup = document.getElementById(`channel-group-${channels.length - 1}`);
          if (newChannelGroup) {
            newChannelGroup.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }, 100);
      };
      
      // Handle cancel button
      document.getElementById('cancelChannelBtn').onclick = function() {
        document.body.removeChild(modal);
      };
      
      // Handle Enter key
      input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          document.getElementById('addChannelBtn').click();
        }
      });
      
      // Handle Escape key
      modal.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          document.body.removeChild(modal);
        }
      });
    }

    function removeChannel(index) {
      console.log('removeChannel called for index:', index);
      if (index < defaultChannels.length) {
        alert('Cannot remove default channels');
        return;
      }
      
      if (!confirm('Remove this channel?')) return;
      
      // Save existing data before removing
      const existingData = channels.map((ch, i) => ({
        name: document.getElementById(`channel-name-${i}`)?.textContent.trim() || ch,
        spend: document.getElementById(`spend_${i}`)?.value || '',
        customers: document.getElementById(`customers_${i}`)?.value || '',
        revenue: document.getElementById(`revenue_${i}`)?.value || ''
      }));
      
      // Remove the channel
      channels.splice(index, 1);
      existingData.splice(index, 1);
      
      initChannelInputs();
      
      // Restore values for remaining channels
      existingData.forEach((data, i) => {
        const nameEl = document.getElementById(`channel-name-${i}`);
        if (nameEl) nameEl.textContent = data.name;
        const spendEl = document.getElementById(`spend_${i}`);
        if (spendEl) spendEl.value = data.spend;
        const custEl = document.getElementById(`customers_${i}`);
        if (custEl) custEl.value = data.customers;
        const revEl = document.getElementById(`revenue_${i}`);
        if (revEl) revEl.value = data.revenue;
      });
    }

    // Make globally accessible immediately
    window.addCustomChannel = addCustomChannel;
    window.removeChannel = removeChannel;

    function initChannelInputs() {
      const container = document.getElementById('channelInputs');
      
      const channelsHtml = channels.map((channel, index) => `
        <div class="channel-input-group" id="channel-group-${index}">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h4 contenteditable="true" id="channel-name-${index}" style="outline: none; cursor: text;">${channel}</h4>
            ${index >= defaultChannels.length ? `<button type="button" onclick="window.removeChannel(${index})" style="background: #dc2626; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">Remove</button>` : ''}
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label>Monthly Spend ($)</label>
              <input type="number" id="spend_${index}" placeholder="5000" step="1">
              <span class="help-text">Enter 0 for free channels</span>
            </div>
            <div class="form-group">
              <label>New Customers</label>
              <input type="number" id="customers_${index}" placeholder="50" step="1">
            </div>
            <div class="form-group">
              <label>Total Revenue ($)</label>
              <input type="number" id="revenue_${index}" placeholder="15000" step="1">
            </div>
          </div>
        </div>
      `).join('');
      
      const addButtonHtml = `
        <div style="margin-top: 24px;">
          <button type="button" onclick="window.addCustomChannel()" class="btn btn-secondary" style="width: 100%;">
            + Add Custom Channel
          </button>
        </div>
      `;
      
      container.innerHTML = channelsHtml + addButtonHtml;
    }

    function goToStep1() {
      document.getElementById('step2').classList.add('hidden');
      document.getElementById('emailGate').classList.add('hidden');
      document.getElementById('step3').classList.add('hidden');
      document.getElementById('step1').classList.remove('hidden');
      document.getElementById('progressBar').style.width = '50%';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function showEmailGate() {
      // First collect channel data
      channelData = channels.map((channel, index) => ({
        name: document.getElementById(`channel-name-${index}`)?.textContent.trim() || channel,
        spend: parseFloat(document.getElementById(`spend_${index}`)?.value) || 0,
        customers: parseFloat(document.getElementById(`customers_${index}`)?.value) || 0,
        revenue: parseFloat(document.getElementById(`revenue_${index}`)?.value) || 0
      }));

      // Show email gate
      document.getElementById('step2').classList.add('hidden');
      document.getElementById('emailGate').classList.remove('hidden');
      document.getElementById('progressBar').style.width = '85%';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function handleEmailSubmit(event) {
      event.preventDefault();
      
      const submitBtn = document.getElementById('unlockResultsBtn');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Processing...';
      submitBtn.disabled = true;

      const leadData = {
        name: document.getElementById('leadName').value,
        email: document.getElementById('leadEmail').value,
        company: document.getElementById('leadCompany').value || '',
        monthlySpend: document.getElementById('leadSpend').value || '',
        totalAuditSpend: channelData.reduce((sum, ch) => sum + ch.spend, 0),
        channelCount: channelData.filter(ch => ch.spend > 0 || ch.revenue > 0).length,
        timestamp: new Date().toISOString()
      };

      try {
        // Send to Mailchimp using their embedded form approach
        await sendToMailchimp(leadData);
        
        // Show results
        document.getElementById('emailGate').classList.add('hidden');
        calculateAndShowResults();
      } catch (error) {
        console.error('Error submitting lead:', error);
        // Still show results even if email capture fails
        document.getElementById('emailGate').classList.add('hidden');
        calculateAndShowResults();
      }

      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
    }

    async function sendToMailchimp(leadData) {
      // Create a hidden iframe for Mailchimp submission (avoids CORS issues)
      const iframe = document.createElement('iframe');
      iframe.name = 'mailchimp-iframe';
      iframe.style.display = 'none';
      document.body.appendChild(iframe);

      // Create form
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = MAILCHIMP_URL;
      form.target = 'mailchimp-iframe';

      // Add fields matching YOUR Mailchimp merge tags
      const fields = {
        'EMAIL': leadData.email,
        'FNAME': leadData.name.split(' ')[0] || '',
        'LNAME': leadData.name.split(' ').slice(1).join(' ') || ''
      };
      
      // Custom fields - using YOUR merge tags from Mailchimp
      if (leadData.company) {
        fields['COMPANY'] = leadData.company;
      }
      if (leadData.monthlySpend) {
        fields['MMERGE4'] = leadData.monthlySpend;
      }
      if (leadData.totalAuditSpend > 0) {
        fields['MMERGE5'] = '$' + leadData.totalAuditSpend.toLocaleString();
      }
      if (leadData.channelCount > 0) {
        fields['MMERGE6'] = leadData.channelCount + ' channels';
      }
      
      console.log('Sending to Mailchimp:', fields);

      for (const [name, value] of Object.entries(fields)) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = name;
        input.value = value;
        form.appendChild(input);
      }

      document.body.appendChild(form);
      form.submit();

      // Clean up after a delay
      setTimeout(() => {
        document.body.removeChild(form);
        document.body.removeChild(iframe);
      }, 2000);

      // Also log to console for backup/debugging
      console.log('Lead captured:', leadData);
    }

    function goToStep2() {
      businessData = {
        aov: parseFloat(document.getElementById('aov').value) || 0,
        cogsPercent: parseFloat(document.getElementById('cogsPercent').value) || 0,
        customerLifetime: parseFloat(document.getElementById('customerLifetime').value) || 0,
        purchaseFrequency: parseFloat(document.getElementById('purchaseFrequency').value) || 0,
        salesCycle: parseFloat(document.getElementById('salesCycle').value) || 0
      };

      document.getElementById('step1').classList.add('hidden');
      document.getElementById('step2').classList.remove('hidden');
      document.getElementById('progressBar').style.width = '75%';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function goToStep2FromResults() {
      document.getElementById('step3').classList.add('hidden');
      document.getElementById('step2').classList.remove('hidden');
      document.getElementById('progressBar').style.width = '75%';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function calculateAndShowResults() {
      // Get actual channel names from contenteditable fields
      const actualChannelNames = channels.map((name, index) => {
        const nameElement = document.getElementById(`channel-name-${index}`);
        return nameElement ? nameElement.textContent.trim() : name;
      });
      
      channelData = actualChannelNames.map((name, index) => ({
        name,
        spend: parseFloat(document.getElementById(`spend_${index}`).value) || 0,
        customers: parseFloat(document.getElementById(`customers_${index}`).value) || 0,
        revenue: parseFloat(document.getElementById(`revenue_${index}`).value) || 0
      }));

      try {
        calculateResults();
        showResults();
      } catch (error) {
        console.error('Error:', error);
        alert('Error calculating results. Please ensure all fields are filled correctly.');
      }
    }

    function calculateResults() {
      const { aov, cogsPercent, customerLifetime, purchaseFrequency, salesCycle } = businessData;
      const grossMargin = aov * (1 - cogsPercent / 100);
      const ltv = aov * purchaseFrequency * (customerLifetime / 12) * (1 - cogsPercent / 100);
      const salesCycleMonths = salesCycle / 30; // Convert days to months for comparison

      const channelResults = channelData
        .filter(ch => {
          // Only include channels that have at least one non-zero value
          return ch.spend > 0 || ch.customers > 0 || ch.revenue > 0;
        })
        .map(channel => {
          const cac = channel.customers > 0 ? channel.spend / channel.customers : 0;
          const roas = channel.spend > 0 ? channel.revenue / channel.spend : 0;
          const cacLtvRatio = ltv > 0 ? cac / ltv : 0;
          const monthlyProfit = (channel.revenue * (1 - cogsPercent / 100)) - channel.spend;
          const paybackPeriod = grossMargin > 0 ? cac / grossMargin : 0;

          let healthScore = 'No Data';
          
          // NEW HEALTH LOGIC - Must pass ALL criteria for good health
          if (channel.spend > 0 || channel.customers > 0 || channel.revenue > 0) {
            const hasProfit = monthlyProfit > 0;
            const goodCacLtv = ltv > 0 && cacLtvRatio <= 0.5;
            const goodPayback = salesCycleMonths > 0 ? (paybackPeriod <= salesCycleMonths) : (paybackPeriod <= 6);
            
            // Channel must be PROFITABLE and have good unit economics
            if (!hasProfit) {
              healthScore = 'Poor'; // Losing money = always poor
            } else if (goodCacLtv && goodPayback) {
              if (cacLtvRatio <= 0.33) healthScore = 'Excellent';
              else healthScore = 'Good';
            } else if (cacLtvRatio <= 1 && hasProfit) {
              healthScore = 'Acceptable'; // Profitable but needs work
            } else {
              healthScore = 'Poor'; // Bad unit economics
            }
          }

          return { ...channel, cac, roas, cacLtvRatio, monthlyProfit, paybackPeriod, healthScore };
        });

      const totalSpend = channelResults.reduce((sum, ch) => sum + ch.spend, 0);
      const totalRevenue = channelResults.reduce((sum, ch) => sum + ch.revenue, 0);
      const totalProfit = channelResults.reduce((sum, ch) => sum + ch.monthlyProfit, 0);
      const validRatios = channelResults.filter(ch => ch.cacLtvRatio > 0);
      const avgCacLtvRatio = validRatios.length > 0 
        ? validRatios.reduce((sum, ch) => sum + ch.cacLtvRatio, 0) / validRatios.length 
        : 0;

      const insights = generateInsights(channelResults, avgCacLtvRatio);

      results = { channelResults, totalSpend, totalRevenue, totalProfit, avgCacLtvRatio, ltv, insights };
    }

    function generateInsights(channelResults, avgCacLtvRatio) {
      const insights = [];
      
      const bestChannel = channelResults.reduce((best, ch) => 
        ch.monthlyProfit > (best?.monthlyProfit || -Infinity) ? ch : best, null);
      const worstChannel = channelResults.reduce((worst, ch) => 
        ch.cacLtvRatio > (worst?.cacLtvRatio || 0) && ch.cacLtvRatio < 999 ? ch : worst, null);
      const unprofitableChannels = channelResults.filter(ch => ch.monthlyProfit < 0);

      if (bestChannel) {
        insights.push(`Your best performing channel is ${bestChannel.name} with $${bestChannel.monthlyProfit.toLocaleString()} in monthly profit. Consider increasing investment here.`);
      }

      if (worstChannel && worstChannel.cacLtvRatio > 1) {
        insights.push(`${worstChannel.name} has a CAC:LTV ratio of ${worstChannel.cacLtvRatio.toFixed(2)}, meaning you're losing money on every customer. This requires immediate attention.`);
      }

      if (unprofitableChannels.length > 0) {
        insights.push(`You have ${unprofitableChannels.length} unprofitable channel(s): ${unprofitableChannels.map(ch => ch.name).join(', ')}. These are actively destroying value.`);
      }

      if (avgCacLtvRatio > 0.5) {
        insights.push(`Your average CAC:LTV ratio of ${avgCacLtvRatio.toFixed(2)} indicates you're spending too much to acquire customers relative to their lifetime value. Industry best practice is below 0.33.`);
      }

      return insights;
    }

    function showResults() {
      document.getElementById('step2').classList.add('hidden');
      document.getElementById('step3').classList.remove('hidden');
      document.getElementById('progressBar').style.width = '100%';
      window.scrollTo({ top: 0, behavior: 'smooth' });

      displayMetricCards();
      displayResultsTable();
      displayProfitChart();
      displayCacLtvChart();
      displayLoadingInsights();
      generateAIInsights();
    }

    function displayLoadingInsights() {
      const container = document.getElementById('insightsList');
      container.innerHTML = `
        <div class="loading-insights">
          <div class="spinner"></div>
          <p>Analyzing your data with AI...</p>
        </div>
      `;
    }

    async function generateAIInsights() {
      console.log('Starting generateAIInsights...');
      console.log('businessData:', businessData);
      console.log('results:', results);
      
      try {
        const prompt = `You are an expert fractional CMO analyzing marketing audit data for a D2C ecommerce brand. 

Business Context:
- Average Order Value: $${businessData.aov}
- COGS: ${businessData.cogsPercent}%
- Customer Lifetime: ${businessData.customerLifetime} months
- Purchase Frequency: ${businessData.purchaseFrequency} times/year
- Sales Cycle Length: ${businessData.salesCycle} DAYS (${(businessData.salesCycle / 30).toFixed(1)} months)
- Customer LTV: $${results.ltv.toFixed(2)}

CRITICAL HEALTH CRITERIA:
A channel is only healthy if ALL of these are true:
1. Monthly profit is POSITIVE (revenue after COGS > spend)
2. Payback period ‚â§ sales cycle (cash flow timing)
3. CAC:LTV ratio is reasonable (< 0.5 for good, < 0.33 for excellent)

If a channel is UNPROFITABLE, it's "Poor" health regardless of CAC:LTV.
If payback > sales cycle, you're spending money before the customer even closes - major cash flow issue.

Channel Performance:
${results.channelResults.map(ch => `
- ${ch.name}:
  * Monthly Spend: $${ch.spend.toLocaleString()} ${ch.spend === 0 ? '(FREE CHANNEL - no acquisition cost)' : ''}
  * New Customers: ${ch.customers}
  * Revenue: $${ch.revenue.toLocaleString()}
  * CAC: ${ch.spend === 0 ? 'N/A (free)' : '$' + ch.cac.toFixed(2)}
  * ROAS: ${ch.roas.toFixed(2)}x
  * CAC:LTV Ratio: ${ch.spend === 0 ? 'N/A' : ch.cacLtvRatio.toFixed(2)}
  * Payback Period: ${ch.spend === 0 ? 'N/A' : ch.paybackPeriod.toFixed(1) + ' months'}
  * Monthly Profit: $${ch.monthlyProfit.toLocaleString()} ${ch.monthlyProfit < 0 ? '(LOSING MONEY)' : ''}
  * Health Score: ${ch.healthScore}
`).join('\n')}

Overall Metrics:
- Total Monthly Spend: $${results.totalSpend.toLocaleString()}
- Total Revenue: $${results.totalRevenue.toLocaleString()}
- Net Marketing Profit: $${results.totalProfit.toLocaleString()}
- Average CAC:LTV Ratio: ${results.avgCacLtvRatio.toFixed(2)}

Please provide a comprehensive marketing strategy analysis with the following sections:

1. KEY INSIGHTS (3-4 strategic insights)
   - Flag any channels that are unprofitable
   - Flag any paid channels where payback > sales cycle
   
2. SPECIFIC OPTIMIZATIONS (3-5 tactical improvements for individual channels)
   - Prioritize fixing unprofitable channels
   - Include recommendations to reduce payback periods
   
3. OPTIMIZED BUDGET RECOMMENDATION (where to reallocate spend)
   - Cut or reduce unprofitable channels
   - Consider payback period in recommendations
   
4. STOP INVESTING (channels to cut or reduce)
   - Always include any channel with negative monthly profit
   - Flag any channels where payback > sales cycle as high risk
   
5. DOUBLE DOWN (channels to scale up)
   - Prioritize profitable channels with short payback periods
   - Consider free channels that drive revenue

Format your response as a JSON object with this structure:
{
  "insights": [
    {
      "priority": "HIGH" | "MEDIUM" | "LOW",
      "title": "Brief title",
      "insight": "Detailed strategic explanation"
    }
  ],
  "optimizations": [
    {
      "channel": "Channel name",
      "action": "Specific optimization",
      "expectedImpact": "What this will achieve",
      "timeframe": "How long to implement"
    }
  ],
  "budgetRecommendation": {
    "summary": "Overall budget strategy",
    "allocations": [
      {
        "channel": "Channel name",
        "currentSpend": current amount,
        "recommendedSpend": recommended amount,
        "reasoning": "Why this change"
      }
    ]
  },
  "stopInvesting": [
    {
      "channel": "Channel name",
      "reason": "Why to cut/reduce",
      "action": "Cut completely or reduce to X"
    }
  ],
  "doubleDown": [
    {
      "channel": "Channel name",
      "reason": "Why it's working",
      "recommendation": "How to scale"
    }
  ]
}

Be specific with numbers. Reference their actual data. Be direct and actionable. Respond ONLY with valid JSON - no markdown, no code blocks.`;

        console.log('Sending request to API_URL:', API_URL);
        
        const response = await fetch(API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            max_tokens: 3000,
            messages: [{ role: "user", content: prompt }]
          })
        });

        console.log('Response status:', response.status);
        console.log('Response ok:', response.ok);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('API Error Response:', errorText);
          throw new Error(`API error: ${response.status}`);
        }

        const data = await response.json();
        console.log('API Response data:', data);
        
        if (!data.content || !data.content[0]) {
          console.error('Invalid response structure:', data);
          throw new Error('Invalid API response structure');
        }
        
        let aiResponse = data.content[0].text;
        
        // Remove markdown code blocks if present
        aiResponse = aiResponse.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        
        console.log('Cleaned AI response:', aiResponse.substring(0, 200) + '...');
        
        const analysis = JSON.parse(aiResponse);
        aiInsightsData = analysis;
        displayAIAnalysis(analysis);
      } catch (error) {
        console.error('Error generating AI insights:', error);
        console.error('Error details:', error.message);
        // Fallback to rule-based insights
        const fallbackInsights = generateInsights(results.channelResults, results.avgCacLtvRatio);
        displayFallbackInsights(fallbackInsights);
      }
    }

    function displayAIAnalysis(analysis) {
      aiInsightsData = analysis;
      const container = document.getElementById('insightsList');
      
      if (!analysis || (!analysis.insights && !analysis.optimizations)) {
        container.innerHTML = `
          <div class="insight-item">
            <strong>Good news!</strong> Your marketing appears relatively healthy. Focus on scaling your best-performing channels and continuously testing for optimization opportunities.
          </div>
        `;
        return;
      }

      let html = '';

      // KEY INSIGHTS SECTION
      if (analysis.insights && analysis.insights.length > 0) {
        html += '<h4 style="font-family: Anton; font-size: 1.25rem; margin-bottom: 16px; margin-top: 0; text-transform: uppercase;">Key Strategic Insights</h4>';
        
        analysis.insights.forEach((insight, index) => {
          const priorityColors = {
            'HIGH': 'background: #fee2e2; border-left-color: #dc2626;',
            'MEDIUM': 'background: #fef3c7; border-left-color: #f59e0b;',
            'LOW': 'background: #e0f2fe; border-left-color: #0284c7;'
          };
          
          const style = priorityColors[insight.priority] || '';
          
          html += `
            <div class="insight-item" style="${style}">
              <strong>${insight.title}</strong>
              <span class="ai-badge">AI Insight</span>
              <p style="margin-top: 8px; line-height: 1.6;">${insight.insight}</p>
            </div>
          `;
        });
      }

      // SPECIFIC OPTIMIZATIONS SECTION
      if (analysis.optimizations && analysis.optimizations.length > 0) {
        html += '<h4 style="font-family: Anton; font-size: 1.25rem; margin-bottom: 16px; margin-top: 32px; text-transform: uppercase;">üîß Specific Optimizations</h4>';
        
        analysis.optimizations.forEach(opt => {
          html += `
            <div class="insight-item" style="background: #EAF6F6; border-left-color: #94EEEE;">
              <strong>${opt.channel}</strong>
              <span class="ai-badge">Optimization</span>
              <p style="margin-top: 8px; line-height: 1.6;">
                <strong>Action:</strong> ${opt.action}<br>
                <strong>Expected Impact:</strong> ${opt.expectedImpact}<br>
                <strong>Timeframe:</strong> ${opt.timeframe}
              </p>
            </div>
          `;
        });
      }

      // BUDGET RECOMMENDATION SECTION
      if (analysis.budgetRecommendation) {
        html += '<h4 style="font-family: Anton; font-size: 1.25rem; margin-bottom: 16px; margin-top: 32px; text-transform: uppercase;">üí∞ Optimized Budget Recommendation</h4>';
        
        html += `
          <div class="insight-item" style="background: #fef3c7; border-left-color: #f59e0b;">
            <strong>Strategy</strong>
            <span class="ai-badge">Budget Plan</span>
            <p style="margin-top: 8px; line-height: 1.6;">${analysis.budgetRecommendation.summary}</p>
          </div>
        `;

        if (analysis.budgetRecommendation.allocations && analysis.budgetRecommendation.allocations.length > 0) {
          html += '<div style="margin-top: 16px; background: white; padding: 20px; border-radius: 6px; border: 1px solid #e5e5e5;">';
          html += '<table style="width: 100%; font-size: 0.9rem;"><tr><th style="text-align: left; padding: 8px; border-bottom: 2px solid #e5e5e5;">Channel</th><th style="text-align: right; padding: 8px; border-bottom: 2px solid #e5e5e5;">Current</th><th style="text-align: right; padding: 8px; border-bottom: 2px solid #e5e5e5;">Recommended</th><th style="text-align: right; padding: 8px; border-bottom: 2px solid #e5e5e5;">Change</th></tr>';
          
          analysis.budgetRecommendation.allocations.forEach(alloc => {
            const change = alloc.recommendedSpend - alloc.currentSpend;
            const changePercent = alloc.currentSpend > 0 ? ((change / alloc.currentSpend) * 100).toFixed(0) : 0;
            const changeColor = change > 0 ? '#059669' : change < 0 ? '#dc2626' : '#666';
            
            html += `
              <tr>
                <td style="padding: 8px; border-bottom: 1px solid #f0f0f0;">${alloc.channel}</td>
                <td style="text-align: right; padding: 8px; border-bottom: 1px solid #f0f0f0;">$${alloc.currentSpend.toLocaleString()}</td>
                <td style="text-align: right; padding: 8px; border-bottom: 1px solid #f0f0f0; font-weight: 600;">$${alloc.recommendedSpend.toLocaleString()}</td>
                <td style="text-align: right; padding: 8px; border-bottom: 1px solid #f0f0f0; color: ${changeColor}; font-weight: 600;">
                  ${change > 0 ? '+' : ''}$${change.toLocaleString()} (${changePercent > 0 ? '+' : ''}${changePercent}%)
                </td>
              </tr>
            `;
          });
          
          html += '</table></div>';
        }
      }

      // STOP INVESTING SECTION
      if (analysis.stopInvesting && analysis.stopInvesting.length > 0) {
        html += '<h4 style="font-family: Anton; font-size: 1.25rem; margin-bottom: 16px; margin-top: 32px; text-transform: uppercase;">üõë Stop Investing</h4>';
        
        analysis.stopInvesting.forEach(item => {
          html += `
            <div class="insight-item" style="background: #fee2e2; border-left-color: #dc2626;">
              <strong>${item.channel}</strong>
              <span class="ai-badge">Action Required</span>
              <p style="margin-top: 8px; line-height: 1.6;">
                <strong>Why:</strong> ${item.reason}<br>
                <strong>Action:</strong> ${item.action}
              </p>
            </div>
          `;
        });
      }

      // DOUBLE DOWN SECTION
      if (analysis.doubleDown && analysis.doubleDown.length > 0) {
        html += '<h4 style="font-family: Anton; font-size: 1.25rem; margin-bottom: 16px; margin-top: 32px; text-transform: uppercase;">üöÄ Double Down</h4>';
        
        analysis.doubleDown.forEach(item => {
          html += `
            <div class="insight-item" style="background: #d1fae5; border-left-color: #059669;">
              <strong>${item.channel}</strong>
              <span class="ai-badge">Scale Opportunity</span>
              <p style="margin-top: 8px; line-height: 1.6;">
                <strong>Why:</strong> ${item.reason}<br>
                <strong>Recommendation:</strong> ${item.recommendation}
              </p>
            </div>
          `;
        });
      }

      container.innerHTML = html;
    }

    function displayFallbackInsights(insights) {
      const container = document.getElementById('insightsList');
      
      if (insights.length === 0) {
        container.innerHTML = `
          <div class="insight-item">
            <strong>Good news!</strong> Your marketing appears relatively healthy. Focus on scaling your best-performing channels and continuously testing for optimization opportunities.
          </div>
        `;
      } else {
        container.innerHTML = insights.map((insight, index) => `
          <div class="insight-item">
            <strong>Insight ${index + 1}:</strong> ${insight}
          </div>
        `).join('');
      }
    }

    function displayMetricCards() {
      const container = document.getElementById('metricCards');
      const profitClass = results.totalProfit > 0 ? 'positive' : 'negative';
      
      container.innerHTML = `
        <div class="metric-card">
          <div class="label">Total Monthly Spend</div>
          <div class="value">$${results.totalSpend.toLocaleString()}</div>
        </div>
        <div class="metric-card">
          <div class="label">Total Revenue</div>
          <div class="value">$${results.totalRevenue.toLocaleString()}</div>
        </div>
        <div class="metric-card ${profitClass}">
          <div class="label">Net Profit</div>
          <div class="value">$${results.totalProfit.toLocaleString()}</div>
        </div>
        <div class="metric-card">
          <div class="label">Avg CAC:LTV</div>
          <div class="value">${results.avgCacLtvRatio.toFixed(2)}</div>
        </div>
      `;
    }

    function displayResultsTable() {
      const container = document.getElementById('resultsTable');
      
      const headers = '<tr><th>Channel</th><th>CAC</th><th>ROAS</th><th>Monthly Profit</th><th>Payback (mo)</th><th>CAC:LTV</th><th>Health</th></tr>';
      
      const rows = results.channelResults.map(ch => {
        const healthClass = ch.healthScore === 'Excellent' ? 'health-excellent' :
                           ch.healthScore === 'Good' ? 'health-good' :
                           ch.healthScore === 'Acceptable' ? 'health-acceptable' : 'health-poor';
        
        const paybackWarning = businessData.salesCycle > 0 && ch.paybackPeriod > (businessData.salesCycle / 30) ? 
          ' style="color: #dc2626; font-weight: 600;"' : '';
        
        // For free channels (spend = 0), show dashes for CAC, Payback, and CAC:LTV
        const isFreeChannel = ch.spend === 0;
        
        return `
          <tr>
            <td><strong>${ch.name}</strong>${isFreeChannel ? ' <span style="color: #059669; font-size: 0.8rem;">(FREE)</span>' : ''}</td>
            <td>${isFreeChannel ? '‚Äî' : '$' + ch.cac.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
            <td>${isFreeChannel && ch.revenue === 0 ? '‚Äî' : ch.roas.toFixed(2) + 'x'}</td>
            <td style="color: ${ch.monthlyProfit >= 0 ? '#059669' : '#dc2626'}; font-weight: 600;">
              $${ch.monthlyProfit.toLocaleString()}
            </td>
            <td${paybackWarning}>${isFreeChannel ? '‚Äî' : ch.paybackPeriod.toFixed(1)}</td>
            <td>${isFreeChannel ? '‚Äî' : ch.cacLtvRatio.toFixed(2)}</td>
            <td><span class="health-badge ${healthClass}">${ch.healthScore}</span></td>
          </tr>
        `;
      }).join('');
      
      container.innerHTML = headers + rows;
    }

    function displayProfitChart() {
      const container = document.getElementById('profitChart');
      const maxProfit = Math.max(...results.channelResults.map(ch => Math.abs(ch.monthlyProfit)));
      
      container.innerHTML = results.channelResults.map(ch => {
        const height = maxProfit > 0 ? (Math.abs(ch.monthlyProfit) / maxProfit) * 250 : 20;
        const color = ch.monthlyProfit >= 0 ? '#059669' : '#dc2626';
        const isFree = ch.spend === 0;
        
        return `
          <div class="chart-bar">
            <div class="bar-column" style="height: ${height}px; background: ${color}">
              <div class="bar-value">$${ch.monthlyProfit.toLocaleString()}</div>
            </div>
            <div class="bar-label">${ch.name}${isFree ? ' (FREE)' : ''}</div>
          </div>
        `;
      }).join('');
    }

    function displayCacLtvChart() {
      const container = document.getElementById('cacLtvChart');
      const maxRatio = Math.max(...results.channelResults.map(ch => ch.cacLtvRatio));
      
      container.innerHTML = results.channelResults.map(ch => {
        const height = (ch.cacLtvRatio / maxRatio) * 250;
        let color = '#059669';
        if (ch.cacLtvRatio > 0.33 && ch.cacLtvRatio <= 0.5) color = '#eab308';
        else if (ch.cacLtvRatio > 0.5 && ch.cacLtvRatio <= 1) color = '#f97316';
        else if (ch.cacLtvRatio > 1) color = '#dc2626';
        
        return `
          <div class="chart-bar">
            <div class="bar-column" style="height: ${height}px; background: ${color}">
              <div class="bar-value">${ch.cacLtvRatio.toFixed(2)}</div>
            </div>
            <div class="bar-label">${ch.name}</div>
          </div>
        `;
      }).join('');
    }

    function generatePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      let yPos = 25;
      
      // Header with branding
      doc.setFillColor(234, 246, 246); // #EAF6F6
      doc.rect(0, 0, 210, 40, 'F');
      
      doc.setFontSize(24);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(26, 26, 26);
      doc.text('SCALE WITH JAYE', 105, 15, { align: 'center' });
      
      doc.setFontSize(18);
      doc.text('PROFIT-FIRST MARKETING AUDIT', 105, 25, { align: 'center' });
      
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      doc.setTextColor(102, 102, 102);
      doc.text(new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }), 105, 32, { align: 'center' });
      
      yPos = 50;
      
      // Executive Summary Box
      doc.setFillColor(148, 238, 238); // #94EEEE
      doc.roundedRect(15, yPos, 180, 45, 3, 3, 'F');
      
      doc.setFontSize(14);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(26, 26, 26);
      doc.text('EXECUTIVE SUMMARY', 20, yPos + 8);
      
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      yPos += 15;
      
      const summaryMetrics = [
        `Total Monthly Marketing Spend: $${results.totalSpend.toLocaleString()}`,
        `Total Revenue Generated: $${results.totalRevenue.toLocaleString()}`,
        `Net Marketing Profit: $${results.totalProfit.toLocaleString()}`,
        `Portfolio CAC:LTV Ratio: ${results.avgCacLtvRatio.toFixed(2)} ${results.avgCacLtvRatio > 0.5 ? '(NEEDS IMPROVEMENT)' : '(HEALTHY)'}`
      ];
      
      summaryMetrics.forEach(metric => {
        doc.text(metric, 20, yPos);
        yPos += 6;
      });
      
      yPos += 15;
      
      // Channel Performance Section
      doc.setFontSize(14);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(26, 26, 26);
      doc.text('CHANNEL PERFORMANCE ANALYSIS', 20, yPos);
      yPos += 10;
      
      doc.setFontSize(9);
      doc.setFont(undefined, 'normal');
      
      results.channelResults.forEach(ch => {
        if (yPos > 270) {
          doc.addPage();
          yPos = 25;
        }
        
        // Channel name
        doc.setFont(undefined, 'bold');
        doc.setFontSize(10);
        doc.text(ch.name, 20, yPos);
        yPos += 6;
        
        // Metrics
        doc.setFont(undefined, 'normal');
        doc.setFontSize(9);
        doc.text(`CAC: $${ch.cac.toFixed(0)} | ROAS: ${ch.roas.toFixed(2)}x | Profit: $${ch.monthlyProfit.toLocaleString()}`, 25, yPos);
        yPos += 5;
        doc.text(`CAC:LTV: ${ch.cacLtvRatio.toFixed(2)} | Health: ${ch.healthScore}`, 25, yPos);
        yPos += 8;
      });
      
      yPos += 5;
      
      // AI Analysis Section
      if (yPos > 240) {
        doc.addPage();
        yPos = 25;
      }
      
      doc.setFillColor(234, 246, 246);
      doc.roundedRect(15, yPos, 180, 10, 2, 2, 'F');
      
      doc.setFontSize(14);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(26, 26, 26);
      doc.text('AI-POWERED MARKETING STRATEGY', 20, yPos + 7);
      yPos += 15;
      
      doc.setFontSize(9);

      // Check if we have AI insights data
      if (aiInsightsData && Object.keys(aiInsightsData).length > 0) {
        
        // Key Insights
        if (aiInsightsData.insights && aiInsightsData.insights.length > 0) {
          doc.setFontSize(12);
          doc.setFont(undefined, 'bold');
          doc.text('KEY STRATEGIC INSIGHTS', 20, yPos);
          yPos += 8;
          
          doc.setFontSize(9);
          aiInsightsData.insights.forEach((insight, index) => {
            if (yPos > 265) {
              doc.addPage();
              yPos = 25;
            }
            
            doc.setFont(undefined, 'bold');
            const lines = doc.splitTextToSize(`${index + 1}. ${insight.title} [${insight.priority}]`, 170);
            lines.forEach(line => {
              doc.text(line, 20, yPos);
              yPos += 5;
            });
            
            doc.setFont(undefined, 'normal');
            const contentLines = doc.splitTextToSize(insight.insight, 170);
            contentLines.forEach(line => {
              if (yPos > 275) {
                doc.addPage();
                yPos = 25;
              }
              doc.text(line, 20, yPos);
              yPos += 4.5;
            });
            yPos += 3;
          });
          yPos += 5;
        }

        // Specific Optimizations
        if (aiInsightsData.optimizations && aiInsightsData.optimizations.length > 0) {
          if (yPos > 250) {
            doc.addPage();
            yPos = 25;
          }
          
          doc.setFontSize(12);
          doc.setFont(undefined, 'bold');
          doc.text('SPECIFIC OPTIMIZATIONS', 20, yPos);
          yPos += 8;
          
          doc.setFontSize(9);
          aiInsightsData.optimizations.forEach((opt, index) => {
            if (yPos > 265) {
              doc.addPage();
              yPos = 25;
            }
            
            doc.setFont(undefined, 'bold');
            doc.text(`${index + 1}. ${opt.channel}`, 20, yPos);
            yPos += 5;
            
            doc.setFont(undefined, 'normal');
            const details = `Action: ${opt.action} | Impact: ${opt.expectedImpact} | Timeline: ${opt.timeframe}`;
            const detailLines = doc.splitTextToSize(details, 170);
            detailLines.forEach(line => {
              if (yPos > 275) {
                doc.addPage();
                yPos = 25;
              }
              doc.text(line, 20, yPos);
              yPos += 4.5;
            });
            yPos += 3;
          });
          yPos += 5;
        }

        // Budget Recommendation
        if (aiInsightsData.budgetRecommendation) {
          if (yPos > 240) {
            doc.addPage();
            yPos = 25;
          }
          
          doc.setFontSize(12);
          doc.setFont(undefined, 'bold');
          doc.text('OPTIMIZED BUDGET RECOMMENDATION', 20, yPos);
          yPos += 8;
          
          doc.setFontSize(9);
          doc.setFont(undefined, 'normal');
          const summaryLines = doc.splitTextToSize(aiInsightsData.budgetRecommendation.summary, 170);
          summaryLines.forEach(line => {
            if (yPos > 275) {
              doc.addPage();
              yPos = 25;
            }
            doc.text(line, 20, yPos);
            yPos += 4.5;
          });
          yPos += 5;
          
          if (aiInsightsData.budgetRecommendation.allocations) {
            aiInsightsData.budgetRecommendation.allocations.forEach(alloc => {
              if (yPos > 273) {
                doc.addPage();
                yPos = 25;
              }
              const change = alloc.recommendedSpend - alloc.currentSpend;
              doc.text(`${alloc.channel}: $${alloc.currentSpend.toLocaleString()} ‚Üí $${alloc.recommendedSpend.toLocaleString()} (${change > 0 ? '+' : ''}$${change.toLocaleString()})`, 20, yPos);
              yPos += 5;
            });
          }
          yPos += 5;
        }

        // Stop Investing
        if (aiInsightsData.stopInvesting && aiInsightsData.stopInvesting.length > 0) {
          if (yPos > 250) {
            doc.addPage();
            yPos = 25;
          }
          
          doc.setFontSize(12);
          doc.setFont(undefined, 'bold');
          doc.text('STOP INVESTING', 20, yPos);
          yPos += 8;
          
          doc.setFontSize(9);
          aiInsightsData.stopInvesting.forEach((item, index) => {
            if (yPos > 265) {
              doc.addPage();
              yPos = 25;
            }
            
            doc.setFont(undefined, 'bold');
            doc.text(`${index + 1}. ${item.channel}`, 20, yPos);
            yPos += 5;
            
            doc.setFont(undefined, 'normal');
            const details = `Why: ${item.reason} | Action: ${item.action}`;
            const detailLines = doc.splitTextToSize(details, 170);
            detailLines.forEach(line => {
              if (yPos > 275) {
                doc.addPage();
                yPos = 25;
              }
              doc.text(line, 20, yPos);
              yPos += 4.5;
            });
            yPos += 3;
          });
          yPos += 5;
        }

        // Double Down
        if (aiInsightsData.doubleDown && aiInsightsData.doubleDown.length > 0) {
          if (yPos > 250) {
            doc.addPage();
            yPos = 25;
          }
          
          doc.setFontSize(12);
          doc.setFont(undefined, 'bold');
          doc.text('DOUBLE DOWN', 20, yPos);
          yPos += 8;
          
          doc.setFontSize(9);
          aiInsightsData.doubleDown.forEach((item, index) => {
            if (yPos > 265) {
              doc.addPage();
              yPos = 25;
            }
            
            doc.setFont(undefined, 'bold');
            doc.text(`${index + 1}. ${item.channel}`, 20, yPos);
            yPos += 5;
            
            doc.setFont(undefined, 'normal');
            const details = `Why: ${item.reason} | How: ${item.recommendation}`;
            const detailLines = doc.splitTextToSize(details, 170);
            detailLines.forEach(line => {
              if (yPos > 275) {
                doc.addPage();
                yPos = 25;
              }
              doc.text(line, 20, yPos);
              yPos += 4.5;
            });
            yPos += 3;
          });
        }
        
      } else {
        // Fallback if no AI data
        doc.setFont(undefined, 'normal');
        doc.text('Your marketing appears relatively healthy. Focus on scaling', 20, yPos);
        yPos += 5;
        doc.text('your best-performing channels and continuous optimization.', 20, yPos);
        yPos += 10;
      }
      
      // Recommendation Box
      if (yPos > 240) {
        doc.addPage();
        yPos = 25;
      }
      
      yPos += 10;
      doc.setFillColor(26, 26, 26);
      doc.roundedRect(15, yPos, 180, 35, 3, 3, 'F');
      
      doc.setFontSize(12);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(255, 255, 255);
      doc.text('NEXT STEPS', 20, yPos + 8);
      
      doc.setFontSize(9);
      doc.setFont(undefined, 'normal');
      doc.setTextColor(229, 229, 229);
      
      const nextSteps = [
        'Review the high-priority insights and create an action plan',
        'Schedule a complimentary audit review call for expert guidance',
        'Implement quick wins in the next 7 days',
        'Set up tracking to measure improvement over time'
      ];
      
      let stepY = yPos + 15;
      nextSteps.forEach((step, i) => {
        doc.text(`${i + 1}. ${step}`, 20, stepY);
        stepY += 5;
      });
      
      // Footer on every page
      const pageCount = doc.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(102, 102, 102);
        doc.text('www.scalewithjaye.com', 105, 287, { align: 'center' });
        doc.text(`Page ${i} of ${pageCount}`, 190, 287, { align: 'right' });
      }
      
      doc.save('profit-first-audit-results.pdf');
    }

    // Initialize
    initChannelInputs();

    // AI Chat Functions
    let chatHistory = [];
    let isChatMinimized = true; // Start minimized

    function toggleAIChat() {
      const chatBox = document.getElementById('aiChatBox');
      const toggle = document.getElementById('aiChatToggle');
      isChatMinimized = !isChatMinimized;
      
      if (isChatMinimized) {
        chatBox.classList.remove('expanded');
        toggle.textContent = '+';
      } else {
        chatBox.classList.add('expanded');
        toggle.textContent = '‚àí';
      }
    }

    function updateChatTitle() {
      const title = document.getElementById('aiChatTitle');
      const currentStep = document.getElementById('step1').classList.contains('hidden') ? 
        (document.getElementById('step2').classList.contains('hidden') ? 'results' : 'step2') : 'step1';
      
      if (currentStep === 'step1') {
        title.textContent = 'Metrics have you stumped? Ask Claude.';
      } else if (currentStep === 'step2') {
        title.textContent = 'Need Help? Ask Claude';
      } else {
        title.textContent = 'Want to Go Deeper? Ask Claude';
      }
    }

    async function sendAIMessage() {
      const input = document.getElementById('aiChatInput');
      const sendBtn = document.getElementById('aiChatSend');
      const messagesContainer = document.getElementById('aiChatMessages');
      
      const userMessage = input.value.trim();
      if (!userMessage) return;
      
      // Add user message to chat
      const userMsgDiv = document.createElement('div');
      userMsgDiv.className = 'ai-message user';
      userMsgDiv.textContent = userMessage;
      messagesContainer.appendChild(userMsgDiv);
      
      // Clear input and disable send button
      input.value = '';
      sendBtn.disabled = true;
      
      // Add loading indicator
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'ai-message loading';
      loadingDiv.innerHTML = '<span>Claude is thinking</span><div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>';
      messagesContainer.appendChild(loadingDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      
      // Build context based on current step
      let context = '';
      const currentStep = document.getElementById('step1').classList.contains('hidden') ? 
        (document.getElementById('step2').classList.contains('hidden') ? 'results' : 'step2') : 'step1';
      
      if (currentStep === 'step1') {
        context = 'The user is on Step 1 filling out business fundamentals (AOV, COGS%, Customer Lifetime, Purchase Frequency, Sales Cycle). ';
      } else if (currentStep === 'step2') {
        context = `The user is on Step 2 entering channel performance data. Business context: AOV=$${businessData.aov}, COGS=${businessData.cogsPercent}%, Lifetime=${businessData.customerLifetime}mo, Frequency=${businessData.purchaseFrequency}/yr, Sales Cycle=${businessData.salesCycle}mo. `;
      } else {
        context = `The user is viewing their audit results. ${JSON.stringify({
          totalSpend: results.totalSpend,
          totalRevenue: results.totalRevenue,
          totalProfit: results.totalProfit,
          avgCacLtvRatio: results.avgCacLtvRatio,
          channels: results.channelResults.map(ch => ({
            name: ch.name,
            spend: ch.spend,
            cac: ch.cac,
            roas: ch.roas,
            profit: ch.monthlyProfit,
            health: ch.healthScore
          }))
        })}. `;
      }
      
      try {
        chatHistory.push({ role: 'user', content: userMessage });
        
        const response = await fetch(API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            max_tokens: 1000,
            system: `You are Claude, an expert marketing consultant helping users complete a profit-first marketing audit. ${context}Be helpful, concise, and actionable. If they ask about metrics or calculations, explain clearly. If they're stuck, guide them step by step.`,
            messages: chatHistory
          })
        });
        
        const data = await response.json();
        const assistantMessage = data.content[0].text;
        
        chatHistory.push({ role: 'assistant', content: assistantMessage });
        
        // Remove loading indicator
        messagesContainer.removeChild(loadingDiv);
        
        // Add assistant message
        const assistantMsgDiv = document.createElement('div');
        assistantMsgDiv.className = 'ai-message assistant';
        assistantMsgDiv.innerHTML = `<strong>Claude:</strong> ${assistantMessage}`;
        messagesContainer.appendChild(assistantMsgDiv);
        
      } catch (error) {
        console.error('Chat error:', error);
        messagesContainer.removeChild(loadingDiv);
        
        const errorDiv = document.createElement('div');
        errorDiv.className = 'ai-message assistant';
        errorDiv.innerHTML = '<strong>Claude:</strong> Sorry, I encountered an error. Please try again.';
        messagesContainer.appendChild(errorDiv);
      }
      
      sendBtn.disabled = false;
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Allow Enter key to send message
    document.getElementById('aiChatInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendAIMessage();
      }
    });

    // Update chat title when navigating between steps
    const originalGoToStep1 = goToStep1;
    goToStep1 = function() {
      originalGoToStep1();
      updateChatTitle();
    };

    const originalGoToStep2 = goToStep2;
    goToStep2 = function() {
      originalGoToStep2();
      updateChatTitle();
    };

    const originalShowResults = showResults;
    showResults = function() {
      originalShowResults();
      updateChatTitle();
    };
  </script>
</body>
</html>
